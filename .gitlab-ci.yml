stages:
  - deploy

deploy-to-ec2:
  stage: deploy
  image: alpine:latest
  
  variables:
    GIT_STRATEGY: clone

  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $EC2_IP_ADDRESS >> ~/.ssh/known_hosts

  script:
    # ---------------------------------------------------------
    # STEP 1: PREPARE FOLDERS (FIXED PATHS)
    # ---------------------------------------------------------
    # "Auth System" ko quotes mein likha hai taaki space ki wajah se error na aaye.
    - ssh $EC2_USERNAME@$EC2_IP_ADDRESS "mkdir -p '/home/ubuntu/project/backend' '/home/ubuntu/project/frontend/Auth System'"

    # ---------------------------------------------------------
    # STEP 2: SUPER CLEANUP (CRITICAL)
    # ---------------------------------------------------------
    - ssh $EC2_USERNAME@$EC2_IP_ADDRESS "docker system prune -a --volumes -f"

    # ---------------------------------------------------------
    # STEP 3: CODE SYNC (SAFE MODE)
    # ---------------------------------------------------------
    # Yeh tumhare poore structure ko waise ka waisa server par copy karega.
    # Agar tumhare git repo mein 'frontend/Auth System' hai, to server par bhi wahi aayega.
    - rsync -avz --delete --exclude 'node_modules' --exclude '.git' --exclude 'dist' --exclude '.env' ./ $EC2_USERNAME@$EC2_IP_ADDRESS:/home/ubuntu/project/

    # ---------------------------------------------------------
    # STEP 4: DOCKER DEPLOY
    # ---------------------------------------------------------
    - |
      ssh $EC2_USERNAME@$EC2_IP_ADDRESS "
        cd /home/ubuntu/project && \
        docker compose up --build -d
      "

  only:
    - main