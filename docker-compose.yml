services:
  # ==========================================
  # BACKEND SERVICE (Target: Builder Stage)
  # ==========================================
  backend:
    container_name: app-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
      # IMPORTANT: Hum 'builder' stage use kar rahe hain kyunki 'runner' stage 
      # se humne dev dependencies (nodemon etc.) hata di thi optimization ke liye.
      target: builder 
    
    # ðŸ”„ HOT RELOAD MAGIC
    volumes:
      - ./backend:/app
      - /app/node_modules # Container ke modules ko protect karta hai
    
    ports:
      - "5000:5000"
    
    networks:
      - app-network
    
    env_file:
      - ./backend/.env
    
    # Dev command (Ensure package.json has "dev": "nodemon ...")
    command: npm run dev
      
    environment:
      - NODE_ENV=development
      - PORT=5000
    
    # Dev mein agar crash ho to restart mat karo, error log padhne do
    restart: "no"
    
    # Healthcheck (Optimized for silence & speed)
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================
  # FRONTEND SERVICE (Target: Development Stage)
  # ==========================================
  frontend:
    container_name: app-frontend
    build:
      context: ./frontend/Auth System
      dockerfile: Dockerfile
      # Matches Stage 1 of Frontend Dockerfile
      target: development
    
    # ðŸ”„ HOT RELOAD MAGIC
    volumes:
      - ./frontend/Auth System:/app
      - /app/node_modules
    
    ports:
      - "5173:5173"
    
    networks:
      - app-network
    
    # Backend ready hone ka wait karega
    depends_on:
      backend:
        condition: service_healthy

    environment:
      # WINDOWS/WSL FIX: Iske bina kabhi-kabhi hot reload detect nahi hota
      - CHOKIDAR_USEPOLLING=true 
    
    command: npm run dev -- --host 0.0.0.0

# ==========================================
# NETWORKS
# ==========================================
networks:
  app-network:
    driver: bridge